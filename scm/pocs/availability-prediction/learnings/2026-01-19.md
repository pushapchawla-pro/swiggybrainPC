# Learnings: Deep Dive into Category Sell Team Operations & Planning
**Date**: January 19, 2025

## Context

This document synthesizes learnings from a deep dive into Instamart's Category Sell Team operations, focusing on understanding how sell plans are created, how targets are tracked, and how the team coordinates with buy, procurement, and warehouse teams. Based on meeting with Shridhar Bhat (Category Sell Team) and analysis of the Jan'26 Target vs Achievement tracker.

---

## 1. Team Overview & Core Function

The Category Sell team is distinct from procurement. While procurement works on existing rates, the sell team collaborates with category teams, buy team, and demand planning team to create the sell plan.

**Core Metrics:**
- Bottom line (profitability)
- Gross Sales Value (GSV)
- Secondary metrics: availability and gap

---

## 2. Jan'26 Target vs Achievement Tracker

A performance tracking sheet shared during the meeting to monitor category-level targets and actuals across various time periods and growth metrics. The sell team uses this data to track daily performance against targets for sales, impressions, and availability.

https://docs.google.com/spreadsheets/d/1f7lI6gb33wyG3guEth51ztWqQi_cRiel_60H4Z-7Smg/edit?usp=sharing

---

## 3. How Sell Plans Are Created

### 3.1 Baseline Calculation

The sell plan is created monthly, starting with a baseline number derived from the Daily Run Rate (DRR). DRR is calculated at the SKU level using data from the last 3 months, segmented by:

| Period Type | Description |
|-------------|-------------|
| **MSF** | Payday sale (1st–7th of month)— |
| **Weekend** | Weekend-specific patterns |
| **BAU** | Business As Usual days |

**DRR Types:**
- **Low DRR**: Average of last 2–3 months, excluding anomalies (e.g., Quim sale)
- **High DRR**: Corresponds to MSF (payday) period

### 3.2 Adjustment Factors

The baseline is then adjusted for:
- **Seasonality** (e.g., chocolates spike during Valentine's, using last year's data)
- **OPD (Orders Per Day) growth**—projections come from the central growth team for the next month
- **AMV (Average Market Value)** along with new launches and spikey demand patterns
- **Market-specific insights** (new launches, brand exclusives)

There is a specific AMV query used for planning.

### 3.3 Do-Nothing Scenario

Formula: `Baseline DRR × Number of Days × OPD × Seasonality Add-ons`

This represents the expected performance without any additional initiatives.


## 4. Incorporating Growth Initiatives

### 4.1 Working Backward from RPC

Brand offer-based planning is a key approach where RPC is calculated backward (Revenue per Cost) and included in the sell plan as incremental bets. To build in brand offers, the team works backward:

1. Define desired RPC spike
2. Calculate necessary discount using elasticity data
3. Determine brand discount requirements

RPC data is shared by the analytics team.

### 4.2 Incremental Commitments

The team commits incremental numbers to brands, which:
- Are built into the sell plan
- Incentivize brands to provide discounts/offers
- Influence margin decisions (higher plans encourage brands to support with more offers)

---

## 5. Metric Shift: GMV to GSV

The team has transitioned from GMV-based calculations (`Quantity × MRP`) to GSV (`Quantity × SP`).
Selling Price = MRP-Discounts

---

## 6. Discount Structure & Funding

### 6.1 Brand Discount Types

CDPO = Customer Discount Per Order which the customer sees on the swiggy app and internally its split into BDPO and SDPO
BDPO is brand discount per order and SDPO is Swiggy Discount Per Order - its basically how much of the discount is split between brand and swiggy - if we have maintiain good Net Margins then we can't be increasing Swiggy Discouting Per Order (SDPO)

| Type | Description |
|------|-------------|
| **BDP** | Brand Discount on Product (product-specific) |


### 6.2 Customer Discount Composition

**CDPO (Customer Discount Per Order) = BDP + SDPO + Liquidation Costs**

Where:
- **BDP**: Brand-funded discount
- **SDPO**: Store Discount Per Order
- **Liquidation**: Costs for clearing slow-moving stock

### 6.3 Risk Mitigation

If BDP falls short, the SKU should ideally be taken down to avoid stockout. If the buy team fails to secure requested BDP (risking stockouts), the sell team may use internal SDPO funding to maintain the plan.

---

## 7. Demand Planning

### 7.1 Primary vs Secondary Demand

- **Primary demand** refers to how much we buy
- **Secondary demand** refers to how much we sell

### 7.2 Assortment Drivers

Assortment is fundamentally driven by three factors:
- Ads
- Store front
- Availability

### 7.3 Advertising Channels

Google ads & Meta ads are used, specifically:
- **PLA** (Product Listing Ads)
- **PCA** (Product Contextual Ads) under search

---

## 8. Cross-Team Coordination

### 8.1 Demand Planning Timeline

| Milestone | Timing | Description |
|-----------|--------|-------------|
| **V1 Plan** | 20th of month | Initial demand plan to buy team |
| **V2 Plan** | 27th–28th | Revised plan adjusting for BDP closures and NPIs |

### 8.2 Information Shared with Buy Team

- BDP requirements (buy team negotiates with brands)
- Secondary sellout plan (ensuring POs account for existing inventory)

### 8.3 Stockout Scenarios

If a product is out of stock at brand level, demand is shifted to alternatives (e.g., cans → bottles) when possible.

---

## 9. Performance Monitoring

### 9.1 Daily Tracking

The team monitors:
- Sales vs. targets
- Impressions
- Availability metrics
- GMV

The team uses specific queries for tracking: AMV query, DPO query, and an Availability sheet maintained by analytics.

### 9.2 Root Cause Analysis

When underperformance occurs, the team investigates:
- Pricing issues
- In-stock problems
- Visibility gaps

---

## 10. Key Queries Shared in the Meeting

### 10.1 DPO Query Logic

The DPO query is used to track discount per order metrics at a granular level. It pulls data from `fin.temp.DPO_COMBINED_V1_V2` and provides visibility into quantity, sales, discounts (BDP, SDPO, EO, LDPO), margins, and COGS at the item level.

**Key Output Columns:**
- Quantity, Total MRP, Total Sales Amount
- Total Actual Discount
- Final Revised BDP, SDPO, EO (Exclusive Offer), LDPO
- Gross Margin, COGS
- NM (Net Margin) including and excluding LDPO

**Query:**

```sql
select
  month,
  case 
    when city = 'Noida' then 'Ghaziabad' 
    when city = 'Noida 1' then 'Noida' 
    when city = 'Cochin' then 'Kochi' 
    else city 
  end as city,
  item_code,
  item_name,
  l1_category,
  l2_category,
  l3_category,
  brand,
  company,
  sum(quantity) as Quantity,
  sum(total_mrp) as TOTAL_MRP,
  sum(total_sales_amount) as TOTAL_SALES_AMOUNT,
  sum(TOTAL_ACTUAL_DISCOUNT) as TOTAL_ACTUAL_DISCOUNT,
  sum(REVISED_BDPO) as FINAL_REVISED_BDPO,
  sum(REVISED_SDPO_) as FINAL_REVISED_SDPO,
  sum(REVISED_SUPER_OFFER) as FINAL_REVISED_EO,
  sum(REVISED_LDPO) as FINAL_REVISED_LDPO,
  sum(gross_margin) as GROSS_MARGIN,
  sum(cogs) as COGS,
  sum(NM_INCL_LDPO) as NM_INCL_LDPO_,
  sum(NM_EXCL_LDPO) as NM_EXCL_LDPO
from fin.temp.DPO_COMBINED_V1_V2
where DT between '2025-12-01' and '2025-12-31'
group by all
order by month desc;
```

**Filter Options Available:**
- Date range or specific week
- Item code
- Brand
- City
- L1 category (e.g., baby care, beauty and grooming, munchies and snacks, etc.)

---

### 10.2 AMV Query Logic

The AMV query is used to track GMV by category alongside OPD (Orders Per Day). It pulls data from `TEMP.PUBLIC.newamvscorecard2` and joins with `analytics.public.srk_category_dashboard_label` to get category-level GMV and order counts by month.

**Key Output Columns:**
- Month
- Category (L1)
- GMV Total
- Orders (distinct order count)

**Query:**

```sql
with opd as (
  SELECT 
    month(a.dt) as month,
    count(Distinct ORDER_ID) as orders
  FROM TEMP.PUBLIC.newamvscorecard2 a
  WHERE (DATE(a.DT) BETWEEN '2025-04-01' AND '2025-10-13')
  group by all
  order by 1
),

gmv as (
  SELECT 
    month(a.dt) as month,
    LOWER(l1_category) as category,
    sum(adjusted_mrp) as GMV_TOTAL
  FROM TEMP.PUBLIC.newamvscorecard2 a
  left join analytics.public.srk_category_dashboard_label b
    ON a.sku_id = b.sku_id 
  WHERE (DATE(a.DT) BETWEEN '2025-04-01' AND '2025-10-13')
    and LOWER(l1_category) in (
      'atta, rice and dals',
      'baby care',
      'bath body and hair',
      'beauty and grooming',
      'biscuits and cakes',
      'cereals and breakfast',
      'chocolates',
      'cleaning essentials',
      'cold drinks and juices',
      'dry fruits and nuts',
      'edible oils and ghee',
      'home and kitchen needs',
      'hygiene and wellness',
      'ice cream and indian sweets',
      'instant food and frozen food',
      'makeup',
      'masala, pickle and papad',
      'munchies and snacks',
      'paan corner',
      'pet supplies',
      'salt, sugar and jaggery',
      'sauces and spreads',
      'tea, coffee and more',
      'nutraceuticals'
    )
  group by all
)

select 
  a.month,
  category,
  gmv_total,
  orders
from gmv a
left join opd b on a.month = b.month;
```


---

## 11. Availability & Fulfillment

### 11.1 Challenges

Warehouse-to-parts fulfillment gap remains a challenge. The team works with the warehouse team daily to address these gaps, using a projected availability goodness factor in the plan.

### 11.2 Operational Practices

- Daily coordination with warehouse team to address gaps
- Track warehouse preparedness: 100% capacity 4 days before month starts (for first 15 days)
- Pullback strategy: Analytics reduces DRR to maintain availability when stock is low
- Warehouse operations involve darkstore movement, preparedness tracking, and movement plan to load

---

## 12. Pricing Strategy

### 12.1 Competitive Monitoring

- Competitor pricing crawl runs 2–3 times
- Price undercutting concerns are raised with brands for correction

### 12.2 Margin Calculation

**Net Landing Cost (NLC):**
- Generally uniform pan-India for most portfolio (based on MRP and percentage margins)
- Exceptions: Market-driven items (dry fruits, sunflower oil)
- Landing cost factors in merchant demand shift considerations

**RM** refers to the profit being made, with a focus on minimum operating profit.

Pricing decisions reference BBPU.

### 12.3 City-Level Variations

Costs can vary by city due to warehouse location considerations (e.g., ₹140 in Delhi vs ₹145 in Mumbai). City-level stapling is also considered in planning.

---

## 13. Product Elasticity & Category Strategy

### 13.1 Elasticity Observations

- Commodity oils (non-premium): Highly price elastic—40% spike observed within 2 hours of price changes
- Thin margins prevent prolonged/excessive discounting

### 13.2 Current Priorities

1. Increasing premium and exclusive product lines
2. Offering competitive exclusive pricing
3. Merchandising focus during high-demand periods (first 7 days of month for staples)

---

## 14. Operational Notes

### 14.1 Price Variation Management

- Use average price based on availability
- Adjust based on inputs and demand planning

### 14.2 Customer Order Limits

- Logic for quantity limits (e.g., max 1–2 items) should be handled by sales team
- Exact daily decision ownership unclear

### 14.3 Automation Status

Automated processes exist for certain pricing calls, but critical metrics remain manually monitored:
- Availability
- BDP status
- Top/bottom line performance

---

## 15. Procurement Process & Accountability (Meeting with Amit Rai)

### 15.1 Role Differentiation
There is a clear distinction between roles in procurement:

One role focuses on exercising correction without needing to fix the problem or deal with stakeholders
Another role requires interpreting data to identify vendor faults or problem sources

### 15.2 Procurement Process Flow

Buy and sell teams analyze demand
Category approval is obtained
Vendor code is created in the system
SKUs are mapped to the correct vendor
Reports are published showing which SKUs are not mapped to a vendor or are live in ERP
These numbers also go to the category team

### 15.3 Accountability for Stockouts
If a product is not supplied and goes out of stock after its lead time expires, it is considered a problem for the planning team, not the procurement team. This is determined based on the age of the Purchase Order (PO).

### 15.4 Availability Metrics & Ownership

Example: 16.51% unavailability impact percentage on DS
Overall business availability target: around 96%
City folks are the primary owners of the availability matrix, not the brand
Three people on the ground serve as an enabling factor

### 15.5 Centralized vs Local Issues
Problems affecting the entire ecosystem should be discussed centrally because city folks cannot solve them unilaterally.

### 15.6 PO and Warehouse Capacity Gap
There is a lack of correlation between raising a PO and the available space in the warehouse. Some people should be focused on their primary job—maintaining a pipeline of POs and inventory. The target is to have 99.9% of the PO and inventory pipeline to meet downstream requirements.

### 15.7 PO Prioritization Query Logic
The PO Prioritization query is used to rank and prioritize Purchase Orders based on multiple weighted factors. It pulls data from multiple sources including RCA data, PO master, and booking portal data to create a comprehensive view of PO urgency and impact.

**Key Weighting Factors:**
- OOS Sessions (normalized)
- Days left to expiry (exponential decay)
- Warehouse DOH
- GMV Band
- QFR Bucket
- Bradman priority flag

**Priority Logic:**
- Bradman SKUs with DOH < 5 get highest priority (1.5x multiplier)
- Bradman SKUs with DOH 5-10 get medium priority (1.2x multiplier)
- POs are ranked within each city-warehouse combination based on Bradman counts, adjusted weight, and balance quantity

**Key Output Columns:**
- City, Warehouse, Vendor details
- PO Code, PO Status
- Balance Quantity
- Item Impact percentage
- Adjusted Weight Final
- Bradman SKU counts (0-5 DOH and 5-10 DOH buckets)
- PO Rank (within city and warehouse)
- Creation date, Expiry date, Booking date
- MOQ/MOV compliance status

**Query:**

```sql
WITH wh_mapping AS (
    SELECT 'AMDTEMP' AS replicated_wh, 'AHM DELHIVERY' AS source_wh
    UNION ALL SELECT 'AHM COLD 1', 'AHM DHLY COLD'
    UNION ALL SELECT 'BLR IM4', 'BLR ECOM2'
    UNION ALL SELECT 'BLR IM3', 'BLR IM1'
    UNION ALL SELECT 'CBE IM1 TEMP', 'CBE ECOM'
    UNION ALL SELECT 'CHE AMB IM2', 'CHN ECOM'
    UNION ALL SELECT 'CNI ECOM', 'CHN ECOM'
    UNION ALL SELECT 'KOL IM2', 'KOLKATA ECOM'
    UNION ALL SELECT 'LKO TEMP', 'LKO IM1'
    UNION ALL SELECT 'LKO IM3', 'LKO IM1'
    UNION ALL SELECT 'PUNE IM2 TEMP','PUN DELHIVERY'
    UNION ALL SELECT 'MUM IM3', 'MUM FC22'
    UNION ALL SELECT 'HYD IM4', 'HYD IM2'
    UNION ALL SELECT 'CHD_IM2','CHD ECOM'
    UNION ALL SELECT 'KOL COLDSTAR 2', 'KOLKATA COLD'
    UNION ALL SELECT 'HYD COLDSTAR 2', 'HYD COLDSTAR'
    UNION ALL SELECT 'HYD IM3 COLD', 'HYD COLDSTAR'
    UNION ALL SELECT 'AMD IM3','AHM DELHIVERY'
)
,rca_base AS (
    SELECT
    city,
    city_id,
    sku,
    skuname,
    company,
    brand_name,
    l1,
    l2,
    business_category,
    whname,
    temp_parmanent,
    business_unit,
    gmv_band,
    pod_tiering,
    pod_count,
    final_rr,
    wh_stock_qty,
    wh_doh,
    doh_category,
    qfr_bucket,
    BS_IMPACT_PERCENTAGE,
    BRADMAN_TAG,
    CASE WHEN total_sessions > 0
         THEN total_sessions - revised_avail_sessions
         ELSE 0
    END AS oos_sessions,

    CASE
        WHEN MAX(total_sessions) OVER (PARTITION BY city, whname) > 0
        THEN (total_sessions - revised_avail_sessions) * 1.0
             / MAX(total_sessions) OVER (PARTITION BY city, whname)
        ELSE 0
    END AS norm_oos_sessions,

    CASE
        WHEN doh_category = '0_OOS' THEN 1
        WHEN doh_category = '1_1-5 DOH' THEN 0.9
        WHEN doh_category = '2_5-10 DOH' THEN 0.3
        WHEN doh_category = '3_10-15 DOH' THEN 0.25
        WHEN doh_category = '4_>15 DOH' THEN 0
        ELSE 0
    END AS wt_wh_doh,

    CASE
        WHEN gmv_band = 1 THEN 1
        WHEN gmv_band = 2 THEN 0.8
        WHEN gmv_band = 3 THEN 0.5
        WHEN gmv_band = 4 THEN 0.1
        WHEN gmv_band = 5 THEN 0.1
        WHEN gmv_band = 6 THEN 0.05
        ELSE 0
    END AS wt_gmv_band,

    CASE
        WHEN qfr_bucket IN ('0% QFR','N_A') THEN 1
        WHEN qfr_bucket = '<=30% QRF' THEN 0.8
        WHEN qfr_bucket = '30%-50% QFR' THEN 0.5
        WHEN qfr_bucket = '50%-80% QRF' THEN 0.3
        WHEN qfr_bucket = '>80% QFR' THEN 0.1
        ELSE 0
    END AS wt_qfr_bucket,

    CASE
        WHEN BRADMAN_TAG = 'BRADMAN'
         AND doh_category IN ('0_OOS', '1_1-5 DOH')
        THEN 1
        ELSE 0
    END AS bradman_doh_priority

FROM temp.public.rca_file_wh
WHERE date(updated_time) = (
        SELECT max(date(updated_time))
        FROM temp.public.rca_file_wh
      )
  AND BUSINESS_UNIT = 'INSTAMART'
  AND city NOT IN ('MUMBAI_1')
  AND total_sessions IS NOT NULL

ORDER BY
    bradman_doh_priority DESC,
    wt_wh_doh DESC,
    norm_oos_sessions DESC
)
,rca_replicated AS (
    SELECT
        r.city, r.city_id, r.sku, r.skuname, r.company, r.brand_name, r.l1, r.l2,
        r.business_category, m.replicated_wh AS whname, r.temp_parmanent, r.business_unit,
        r.gmv_band, r.pod_tiering, r.pod_count, r.final_rr, r.wh_stock_qty, r.wh_doh,
        r.doh_category, r.qfr_bucket,r.BS_IMPACT_PERCENTAGE,r.BRADMAN_TAG, r.oos_sessions,r.norm_oos_sessions, r.wt_wh_doh, r.wt_gmv_band, r.wt_qfr_bucket,r.bradman_doh_priority
    FROM rca_base r
    JOIN wh_mapping m ON r.whname = m.source_wh
)
,rca AS(
SELECT * FROM rca_base
UNION ALL
SELECT * FROM rca_replicated
)
,oospercentile as (
    select
    city,
    whname,
        percentile_cont(0.30) within group (order by norm_oos_sessions) as p30,
        percentile_cont(0.65) within group (order by norm_oos_sessions) as p50,
        percentile_cont(0.75) within group (order by norm_oos_sessions) as p80,
        percentile_cont(0.85) within group (order by norm_oos_sessions) as p90,
        percentile_cont(0.95) within group (order by norm_oos_sessions) as p95
    from rca
    where norm_oos_sessions > 0
    group by city,whname
)
,sku as (
    select distinct
    sku,
    displaysku,
    max(skuname) as skuname
    from vinculum.swiggy_gamma.sku
    group by 1,2
),
l3mapping as(
    select distinct
    try_parse_json(d.THIRDPARTYATTRIBUTES):"id"::string as Item_Code,
    try_parse_json(attributes):"super_category/L1"::string as L1,
    try_parse_json(attributes):"category/L2"::string as L2,
    try_parse_json(attributes):"sub-category/L3"::string as L3,
    try_parse_json(d.attributes):"product name"::string item_name,
    try_parse_json(d.attributes):"brand_company"::string brand_company,
    try_parse_json(d.attributes):"brand"::string brand,
    try_parse_json(d.attributes):"mrp"::string mrp
    from cms.cms_ddb.cms_spins_1 d
    where l1 is not null
    and l2 is not null
    and businessline in ('INSTAMART')
),
skudets as (
    select distinct
    item_code,
    product_name,
    l1_category,
    l2_category,
    l3_category
    from analytics.public.store_spin_sku_det
    where l1_category is not null
),
Vd as (
    select supplier_name as vendorname,
    vinculum_vendor_code
    from DASH_ERP_ENGG.DASH_ERP_ENGG_DDB.DASH_SCM_SUPPLIER_MASTER
),
clm as (
    select clientshortname,
    clientname
    from vinculum.swiggy_gamma.clientmaster
),
locg as (
    select loccode,
    locname,
    city,
    udf1
    from VINCULUM.SWIGGY_GAMMA.LOCATION
),
gpo as (
    select pocode,
    case
        when status = 1 then 'Pending Confirmation'
        when status = 4 then 'Confirmed'
        when status = 5 then 'Release In Process'
        when status = 6 then 'Error In Releasing'
        when status = 7 then 'Cancelled'
        when status = 10 then 'Released'
        when status = 13 then 'Reopen'
        when status = 16 then 'Reconfirmed'
        when status = 19 then 'Partially Received'
        when status = 22 then 'Received'
        when status = 25 then 'Short Closed'
        when status = 28 then 'Closed'
        when status = 31 then 'Expired'
    end as POStatus,
    nvl(externpocode,'-') as extpocode,
    split_part(vendorcode,'-',1) as Entity,
    split_part(vendorcode,'-',2) as vendor_code,
    date(crtdate) as crtdate,
    date(expirydate) as expdate,
    dellocationcode,
    udf1 as OTBReferenceno,
    rcvvalidationcode as validationcode,    
    referencepocode as refpocode    
    from vinculum.swiggy_gamma.po
    where crtdate > '2024-04-01'
    and vendor_code not in ('%Scootsy%')
),
gpod as (
    select pocode,
    sku.displaysku as itemcode,
    sku.skuname,
    eaqty as poqty,
    nvl(rcvdqty,0) as receivedqty,
    (eaqty - nvl(rcvdqty,0)) as balanceqty,
    unitbasecost as unitcost,
    mrp
    from vinculum.swiggy_gamma.podetail as pd
    left join sku on pd.sku = sku.sku
    where pd.crtdate >'2024-04-01'
),
finalview as (
    select locg.udf1 as City,
    upper(locg.locname) as whname,
    clm.clientname as entity,
    gpo.pocode,
    gpo.postatus,
    gpo.vendor_code,
    vd.vendorname,
    gpod.itemcode,
    nvl(gpod.skuname,'-')as skuname,
    gpod.poqty,
    gpod.receivedqty,
    gpod.balanceqty,
    gpod.mrp,
    gpod.unitcost,
    gpo.crtdate,
    gpo.expdate,
    gpo.expdate - current_date as days_left,
    gpo.OTBReferenceno,
    nvl(gpo.refpocode,'-') as refpocode,
    initcap(coalesce(l3m.l1,s.l1_category,'Unknown L1')) as l_one,
    initcap(coalesce(l3m.l2,s.l2_category,'Unknown L2')) as l_two,
    coalesce(l3m.brand_company,'Unknown Company') as company,
    coalesce(l3m.brand,'Unknown Brand') as brand,
    case
        when (gpod.receivedqty/gpod.poqty) >= 0.8 then 0
        else 1
    end as qfr_flag
    from gpo
    left join gpod on gpo.pocode = gpod.pocode
    left join vd on gpo.vendor_code = vd.vinculum_vendor_code
    left join locg on gpo.dellocationcode = locg.loccode
    left join clm on gpo.entity = clm.clientshortname
    left join l3mapping l3m on gpod.itemcode = l3m.item_code
    left join skudets s on gpod.itemcode = s.item_code
    where gpo.crtdate > current_date - 160
    and upper(gpo.OTBReferenceno) not like '%STO%'
    and gpo.vendor_code not like '%Scootsy%'
    and gpo.vendor_code not like '%SCOOTSY%'
    and upper(gpod.skuname) not like '%SAMPLE%'
    and upper(gpod.skuname) not like '%FREEBIE%'
    and upper(gpod.skuname) not like '%FLYER%'
    and upper(locg.locname) not like '%FNV%'
    and upper(locg.locname) not like '%PHARMA%'
    and gpo.expdate is not null
    and gpo.postatus in ('Partially Received','Released')
    and upper(l_one) IN ('HOME AND KITCHEN NEEDS','EDIBLE OILS AND GHEE','MUNCHIES AND SNACKS','BISCUITS AND CAKES','CLEANING ESSENTIALS','CHOCOLATES','COLD DRINKS AND JUICES',
'ICE CREAM AND INDIAN SWEETS','DAIRY, BREAD AND EGGS','MASALA, PICKLE AND PAPAD',
'INSTANT FOOD AND FROZEN FOOD','HYGIENE AND WELLNESS','BEAUTY AND GROOMING',
'CEREALS AND BREAKFAST','DRY FRUITS AND NUTS','BABY CARE','ATTA, RICE AND DALS',
'SAUCES AND SPREADS','BATH BODY AND HAIR','TEA, COFFEE AND MORE','PAAN CORNER',
'SALT, SUGAR AND JAGGERY','PET SUPPLIES','NUTRACEUTICALS','MAKEUP',
'MEAT AND SEA FOOD','BAKERY')
    and gpod.balanceqty > 0
    order by gpo.expdate,gpo.pocode,gpod.balanceqty desc
),
posummary as(
    select whname,
    itemcode,
    sum(balanceqty) as bal_qty
    from finalview
    group by all
),
l1ctr as (
    select pocode,
    l_one,
    count(*) as l1_ctr,
    row_number() over (partition by pocode order by count(*) desc) as rank
    from finalview
    where qfr_flag = 1
    group by pocode, l_one
),
topl1 as(
    select pocode,l_one,l1_ctr
    from l1ctr
    where rank = 1
)
,fview as (
    SELECT
    f.city,
    f.whname,
    f.vendor_code,
    f.vendorname,
    f.pocode,
    f.postatus,
    f.itemcode,
    f.balanceqty,
    f.crtdate,
    f.expdate,
    f.days_left,
    r.final_rr,
    r.wh_doh,
    r.oos_sessions,
    r.norm_oos_sessions,
    r.BS_IMPACT_PERCENTAGE,
    r.BRADMAN_TAG,
    r.bradman_doh_priority,
    p.bal_qty AS ttl_intransit,
    NVL(r.wt_wh_doh,0) AS wt_whdoh,
    NVL(r.wt_gmv_band,0) AS wt_gmvband,
    NVL(r.wt_qfr_bucket,0) AS wt_frbucket,
    f.qfr_flag,
    NVL(op.p95,0) AS p_95,
    NVL(op.p90,0) AS p_90,
    NVL(op.p80,0) AS p_80,
    NVL(op.p50,0) AS p_50,
    NVL(op.p30,0) AS p_30,

    CASE
        WHEN r.norm_oos_sessions >= p_95 THEN 1
        WHEN r.norm_oos_sessions >= p_90 THEN 0.8
        WHEN r.norm_oos_sessions >= p_80 THEN 0.6
        WHEN r.norm_oos_sessions >= p_50 THEN 0.4
        WHEN r.norm_oos_sessions >= p_30 THEN 0.2
        ELSE 0
    END AS wt_oos_sessions,

    CASE
        WHEN f.days_left < 0 THEN 1
        ELSE EXP(- f.days_left / 3.0)
    END AS wt_days_left_exp,

    LEAST(
        1.0,
        GREATEST(
            0.05,
            f.balanceqty * 1.0 / NULLIF(p.bal_qty,0)
        )
    ) AS norm_intransit_ratio,

    CASE
        WHEN f.qfr_flag = 0 THEN 0
        WHEN f.qfr_flag = 1 AND r.norm_oos_sessions > 0 THEN
            (
                (0.40 *
                    CASE
                        WHEN r.norm_oos_sessions >= p_95 THEN 1
                        WHEN r.norm_oos_sessions >= p_90 THEN 0.8
                        WHEN r.norm_oos_sessions >= p_80 THEN 0.6
                        WHEN r.norm_oos_sessions >= p_50 THEN 0.4
                        WHEN r.norm_oos_sessions >= p_30 THEN 0.2
                        ELSE 0
                    END
                ) +
                (0.30 *
                    CASE
                        WHEN f.days_left < 0 THEN 1
                        ELSE EXP(- f.days_left / 3.0)
                    END
                ) +
                (0.10 * NVL(r.wt_wh_doh,0)) +
                (0.10 * NVL(r.wt_gmv_band,0)) +
                (0.10 *
                    LEAST(
                        1.0,
                        GREATEST(
                            0.05,
                            f.balanceqty * 1.0 / NULLIF(p.bal_qty,0)
                        )
                    )
                ) +
                (0.10 * NVL(r.wt_qfr_bucket,0))
            )
        WHEN f.qfr_flag = 1 AND r.norm_oos_sessions = 0 THEN
            (
                (0.35 *
                    CASE
                        WHEN f.days_left < 0 THEN 1
                        ELSE EXP(- f.days_left / 3.0)
                    END
                ) +
                (0.20 * NVL(r.wt_wh_doh,0)) +
                (0.20 * NVL(r.wt_gmv_band,0)) +
                (0.15 *
                    LEAST(
                        1.0,
                        GREATEST(
                            0.05,
                            f.balanceqty * 1.0 / NULLIF(p.bal_qty,0)
                        )
                    )
                ) +
                (0.10 * NVL(r.wt_qfr_bucket,0))
            )
        ELSE 0
    END AS wt_final,

    CASE
        WHEN r.bradman_doh_priority = 1 THEN
            (1.5 + wt_final * 1.2)
        ELSE
            wt_final
    END AS final_wt

FROM finalview f
LEFT JOIN posummary p
    ON UPPER(f.whname) = UPPER(p.whname)
   AND f.itemcode = p.itemcode
LEFT JOIN rca r
    ON UPPER(f.whname) = UPPER(r.whname)
   AND f.itemcode = r.sku
LEFT JOIN oospercentile op
    ON UPPER(f.whname) = UPPER(op.whname)
WHERE f.balanceqty > 0
),
po_coverage AS (
  SELECT
    f.*,
    r.final_rr,
    r.wh_doh AS current_doh,
    CASE WHEN r.final_rr > 0 THEN f.balanceqty * 1.0 / r.final_rr ELSE 0 END AS po_doh_addition,
    GREATEST(0, 10.0 - r.wh_doh) AS doh_gap,
    SUM(CASE WHEN r.final_rr > 0 THEN f.balanceqty * 1.0 / r.final_rr ELSE 0 END)
        OVER (PARTITION BY f.whname, f.itemcode ORDER BY f.crtdate, f.pocode ROWS BETWEEN UNBOUNDED PRECEDING AND CURRENT ROW)
    AS cumulative_cover_days
  FROM fview f
  LEFT JOIN rca r ON UPPER(f.whname) = UPPER(r.whname) AND f.itemcode = r.sku
  WHERE balanceqty > 0
),
po_weighted AS (
     SELECT
    *,
    LEAST(
      po_doh_addition,
      GREATEST(0, doh_gap - (cumulative_cover_days - po_doh_addition))
    ) / NULLIF(doh_gap, 0) AS coverage_ratio,
   
    (
    (CASE
        WHEN qfr_flag = 0 THEN 0
        WHEN qfr_flag = 1 AND norm_oos_sessions > 0 THEN
            (0.40 * wt_oos_sessions) +
            (0.30 * wt_days_left_exp) +
            (0.10 * wt_whdoh) +
            (0.10 * wt_gmvband) +
            (0.10 * norm_intransit_ratio) +
            (0.10 * wt_frbucket)
        WHEN qfr_flag = 1 AND norm_oos_sessions = 0 THEN
            (0.35 * wt_days_left_exp) +
            (0.20 * wt_whdoh) +
            (0.20 * wt_gmvband) +
            (0.15 * norm_intransit_ratio) +
            (0.10 * wt_frbucket)
        ELSE 0
    END)
    *
    LEAST(
        po_doh_addition,
        GREATEST(0, doh_gap - (cumulative_cover_days - po_doh_addition))
    ) / NULLIF(doh_gap, 0)
)
*
CASE
    WHEN bradman_doh_priority = 1 AND current_doh < 5 THEN 1.5
    WHEN bradman_doh_priority = 1 AND current_doh BETWEEN 5 AND 10 THEN 1.2
    ELSE 1.0
END
AS adjusted_wt_final,
COUNT(CASE WHEN BRADMAN_TAG = 'BRADMAN' THEN 1 END) OVER (PARTITION BY pocode) AS bradman_sku_count,
SUM(CASE WHEN BRADMAN_TAG = 'BRADMAN' THEN balanceqty ELSE 0 END) OVER (PARTITION BY pocode) AS bradman_sku_qty,
COUNT(CASE WHEN bradman_doh_priority = 1 AND current_doh < 5 THEN 1 END) OVER (PARTITION BY pocode) AS bradman_sku_lt5doh_count,
SUM(CASE WHEN bradman_doh_priority = 1 AND current_doh < 5 THEN balanceqty ELSE 0 END) OVER (PARTITION BY pocode) AS bradman_sku_lt5doh_qty
FROM po_coverage
),
sku_po_level AS (
    SELECT
        city,
        whname,
        vendor_code,
        vendorname,
        itemcode,
        pocode,
        BRADMAN_TAG,
        current_doh,
        po_doh_addition,
        doh_gap,
        LEAST(po_doh_addition, doh_gap) AS doh_contrib,
        ROW_NUMBER() OVER (
          PARTITION BY city, whname, vendor_code, vendorname, itemcode
          ORDER BY bradman_doh_priority DESC, adjusted_wt_final DESC, pocode
        ) AS po_order
    FROM po_weighted
),
sku_gap AS (
    SELECT
        city,
        whname,
        vendor_code,
        vendorname,
        pocode,
        itemcode,
        MAX(BRADMAN_TAG) AS bradman_tag,
        MAX(current_doh) AS current_doh,
        MAX(po_doh_addition) AS po_doh,
        MAX(doh_gap) AS doh_gap,
        MAX(cumulative_cover_days) AS cumulative_cover_days,
        MAX(current_doh) + MAX(po_doh_addition) AS final_doh
    FROM po_weighted
    GROUP BY
        city, whname, vendor_code, vendorname, pocode, itemcode
)
, sku_po_running AS (
    SELECT
        s.*,
        SUM(doh_contrib) OVER (
          PARTITION BY city, whname, vendor_code, vendorname, itemcode
          ORDER BY po_order
          ROWS BETWEEN UNBOUNDED PRECEDING AND CURRENT ROW
        ) AS cum_doh_contrib
    FROM sku_po_level s
)
, sku_po_alloc AS (
    SELECT
        r.*,
        LAG(cum_doh_contrib) OVER (
          PARTITION BY city, whname, vendor_code, vendorname, itemcode
          ORDER BY po_order
        ) AS cum_doh_before_po
    FROM sku_po_running r
),
 effective_sku_po AS (
    SELECT
        city,
        whname,
        vendor_code,
        vendorname,
        itemcode,
        pocode,
        BRADMAN_TAG,
        current_doh,
        doh_contrib,
        cum_doh_contrib,
        cum_doh_before_po,
        CASE
          WHEN current_doh + COALESCE(cum_doh_before_po, 0) < 10 THEN 1
          ELSE 0
        END AS po_used_flag,
        LEAST(current_doh + doh_contrib, 10) AS final_doh_for_po
    FROM sku_po_alloc
)
, bucketed AS (
    SELECT
        e.*,
        CASE
          WHEN BRADMAN_TAG = 'BRADMAN'
               AND po_used_flag = 1
               AND current_doh < 5
               AND final_doh_for_po > 0
          THEN 1 ELSE 0
        END AS bradman_sku_0_5_flag,
        CASE
          WHEN BRADMAN_TAG = 'BRADMAN'
               AND po_used_flag = 1
               AND current_doh >= 5
               AND current_doh < 10
               AND final_doh_for_po > current_doh
          THEN 1 ELSE 0
        END AS bradman_sku_5_10_flag
    FROM effective_sku_po e
)
,po_bucket_agg AS (
    SELECT
        city,
        whname,
        vendor_code,
        vendorname,
        pocode,
        SUM(bradman_sku_0_5_flag) AS bradman_sku_0_5_count,
        SUM(bradman_sku_5_10_flag) AS bradman_sku_5_10_count
    FROM bucketed
    GROUP BY city, whname, vendor_code, vendorname, pocode
),
po_item_ranked as (
    SELECT
        f.whname,
        f.itemcode,
        f.pocode,
        f.crtdate,
        f.BS_IMPACT_PERCENTAGE,
        ROW_NUMBER() OVER (PARTITION BY f.whname, f.itemcode ORDER BY f.crtdate ASC) AS sku_po_rank
    FROM fview f
)
,impact_allocation as (
    SELECT
        *,
        CASE
            WHEN sku_po_rank = 1 THEN BS_IMPACT_PERCENTAGE
            WHEN sku_po_rank = 2 THEN BS_IMPACT_PERCENTAGE * 0.3
            WHEN sku_po_rank = 3 THEN BS_IMPACT_PERCENTAGE * 0.2
            WHEN sku_po_rank = 4 THEN BS_IMPACT_PERCENTAGE * 0.1
            WHEN sku_po_rank = 5 THEN BS_IMPACT_PERCENTAGE * 0.05
            ELSE 0
        END AS allocated_impact
    FROM po_item_ranked
)
,po_item_impact AS (
   SELECT
    pocode,
    COALESCE(SUM(allocated_impact), 0) AS ITEM_IMPACT
    FROM impact_allocation
GROUP BY pocode
),
linesperpo as (
    select pocode,count(*) as lines_per_po
    from finalview
    where qfr_flag = 1
    group by pocode
),
TEMP_PO_COMPLIANCE_EXPLODED AS (
  SELECT
    Q.WHNAME,
    Q.POCDATE,
    Q.VINCULUM_VENDOR_CODE,
    Q.MOQ_MOV_TYPE,
    Q.EFFECTIVE_MOQ_MOV,
    Q.TOTAL_UNITS,
    Q.TOTAL_CASES,
    Q.TOTAL_KG,
    Q.TOTAL_VALUE,
    Q.PO_VS_MOQ_MOV_PERCENT,
    Q.PO_COMPLIANCE_STATUS,
    value::string AS POCODE
  FROM TEMP.PUBLIC.PO_MOQ_MOV_CHECK Q,
       LATERAL FLATTEN(input => Q.ALL_POCODES)
),
RAW_APPT AS (
    SELECT
        a.*,
        PARSE_JSON(third_party_attributes):vinc_attr:po_number::STRING AS PONO,
        PARSE_JSON(third_party_attributes):vinc_attr:vendor_code::STRING AS VENDOR_CODE,
        PARSE_JSON(supplier):supplier_name::STRING AS SUPPLIER_NAME,
        PARSE_JSON(fc):id::STRING AS FCID,
        PARSE_JSON(slot):slot_id::STRING AS SLOT_ID,
        PARSE_JSON(fc):party_type::STRING AS PARTY_TYP,
        p.dellocationcode,
        p.udf1,
        TRY_CAST(a.date AS DATE) AS BOOKING_DATE
    FROM CDC.CDC_DDB.scm_fc_inbound_appointment a
    LEFT JOIN VINCULUM.SWIGGY_GAMMA.PO p
        ON PARSE_JSON(third_party_attributes):vinc_attr:po_number::STRING = p.pocode
    WHERE a.appt_state = 'CREATED'
      AND a.sk != 'fc_inbound_appointment'
      AND TRY_CAST(a.date AS DATE) >= DATEADD(DAY, -1, CURRENT_DATE())
),
BOOKING_PORTAL AS (
 SELECT
        *,
        ROW_NUMBER() OVER (
            PARTITION BY PONO
            ORDER BY BOOKING_DATE ASC
        ) AS rn
    FROM RAW_APPT
    WHERE BOOKING_DATE >= CURRENT_DATE()
)
SELECT
    f.city,
    f.whname,
    f.vendor_code,
    f.vendorname,
    f.pocode,
    SUM(f.balanceqty) AS bal_qty,
    MAX(n.ITEM_IMPACT) AS ITEM_IMPACT,
    COALESCE(SUM(f.adjusted_wt_final) / NULLIF(lp.lines_per_po, 0), 0) AS avg_adjusted_wt_final,
    COALESCE(pba.bradman_sku_0_5_count, 0) AS bradman_sku_0_5_count,
    COALESCE(pba.bradman_sku_5_10_count, 0) AS bradman_sku_5_10_count,
    ROW_NUMBER() OVER (
        PARTITION BY f.city, f.whname
        ORDER BY
            CASE WHEN COALESCE(pba.bradman_sku_0_5_count, 0)
                      + COALESCE(pba.bradman_sku_5_10_count, 0) > 0
                 THEN 0 ELSE 1 END,
            COALESCE(pba.bradman_sku_0_5_count, 0) DESC,
            COALESCE(pba.bradman_sku_5_10_count, 0) DESC,
            avg_adjusted_wt_final DESC,
            bal_qty DESC
    ) AS po_rank,
    f.crtdate,
    f.expdate,
    bp.BOOKING_DATE,
    l.l_one,
    lp.lines_per_po,
    t.MOQ_MOV_TYPE,
    t.EFFECTIVE_MOQ_MOV,
    t.TOTAL_UNITS,
    t.TOTAL_CASES,
    t.TOTAL_KG,
    t.TOTAL_VALUE,
    t.PO_VS_MOQ_MOV_PERCENT,
    t.PO_COMPLIANCE_STATUS,
    f.postatus
FROM po_weighted f
LEFT JOIN topl1 l ON f.pocode = l.pocode
LEFT JOIN linesperpo lp ON f.pocode = lp.pocode
LEFT JOIN TEMP_PO_COMPLIANCE_EXPLODED t ON f.pocode = t.pocode
LEFT JOIN po_item_impact n ON f.pocode = n.pocode
LEFT JOIN po_bucket_agg pba ON f.city = pba.city
                              AND f.whname = pba.whname
                              AND f.vendor_code = pba.vendor_code
                              AND f.vendorname = pba.vendorname
                              AND f.pocode = pba.pocode
LEFT JOIN BOOKING_PORTAL bp ON f.POCODE = bp.PONO AND bp.rn = 1
WHERE l.l_one IS NOT NULL
GROUP BY
    f.city,
    f.whname,
    f.vendor_code,
    f.vendorname,
    f.pocode,
    f.crtdate,
    f.expdate,
    l.l_one,
    lp.lines_per_po,
    t.MOQ_MOV_TYPE,
    t.EFFECTIVE_MOQ_MOV,
    t.TOTAL_UNITS,
    t.TOTAL_CASES,
    t.TOTAL_KG,
    t.TOTAL_VALUE,
    t.PO_VS_MOQ_MOV_PERCENT,
    t.PO_COMPLIANCE_STATUS,
    f.postatus,
    pba.bradman_sku_0_5_count,
    pba.bradman_sku_5_10_count,
    bp.BOOKING_DATE
ORDER BY f.city, f.whname, po_rank;
```

**Data Sources:**
- `temp.public.rca_file_wh` - RCA base data
- `vinculum.swiggy_gamma.po` - PO master
- `vinculum.swiggy_gamma.podetail` - PO line items
- `TEMP.PUBLIC.PO_MOQ_MOV_CHECK` - MOQ/MOV compliance
- `CDC.CDC_DDB.scm_fc_inbound_appointment` - Booking portal appointments

---

## 16. Questions to be Addressed

1. What is the KRA of the Demand Planning team?
2. How and how often does Demand Planning track the run rate?
3. What does the IM Corp team do exactly—is it execution or decision making?
4. Once the PO is raised, what all things can go wrong?

---

**Date**: January 19, 2025